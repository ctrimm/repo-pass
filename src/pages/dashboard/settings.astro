---
import Layout from '../../layouts/main.astro';
import DashboardNav from '../../components/DashboardNav.astro';
import Footer from '../../components/Footer.astro';
import { requireAuth } from '../../lib/auth';
import { db, users } from '../../db';
import { eq } from 'drizzle-orm';

let session;
try {
  session = await requireAuth(Astro.cookies);
} catch (error) {
  return Astro.redirect('/');
}

// Fetch current user's settings
const user = await db.query.users.findFirst({
  where: eq(users.id, session.userId),
});

if (!user) {
  return Astro.redirect('/');
}

const paymentProvider = user.paymentProvider || '';

// Check for success messages
const successType = Astro.url.searchParams.get('success');
---

<Layout title="Settings - RepoPass">
  <div class="min-h-screen bg-background flex flex-col">
    <DashboardNav />

    <main class="flex-1 max-w-4xl mx-auto px-4 py-8 w-full">
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Settings</h1>
        <p class="mt-2 text-gray-600">Configure your payment provider and repository access</p>
      </div>

      {
        successType && (
          <div class="mb-6 bg-green-50 border border-green-200 rounded-lg p-4" id="success-message">
            <div class="flex items-start">
              <svg class="w-5 h-5 text-green-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd"
                />
              </svg>
              <div class="ml-3">
                <p class="text-sm font-medium text-green-800">
                  {successType === 'email-preferences' && 'Email preferences saved successfully!'}
                  {successType === 'payment-provider' &&
                    'Payment provider configured successfully!'}
                  {successType === 'github-pat' && 'GitHub token saved successfully!'}
                </p>
              </div>
              <button
                onclick="document.getElementById('success-message').remove()"
                class="ml-auto text-green-600 hover:text-green-800"
              >
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path
                    fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
          </div>
        )
      }

      <!-- Payment Provider Section -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Payment Provider</h2>
        <p class="text-sm text-gray-600 mb-6">
          Connect a payment provider to start selling access to your repositories. Your API keys are
          encrypted and stored securely.
        </p>

        <form
          id="payment-provider-form"
          method="POST"
          action="/api/dashboard/settings/payment-provider"
        >
          <!-- Provider Selection -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Select Payment Provider
            </label>
            <select
              name="provider"
              id="provider-select"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent"
            >
              <option value="">-- Select a provider --</option>
              <option value="stripe" selected={paymentProvider === 'stripe'}>Stripe</option>
              <option value="lemon_squeezy" selected={paymentProvider === 'lemon_squeezy'}>
                Lemon Squeezy
              </option>
              <option value="gumroad" selected={paymentProvider === 'gumroad'}>Gumroad</option>
              <option value="paddle" selected={paymentProvider === 'paddle'}>Paddle</option>
            </select>
          </div>

          <!-- Stripe Fields -->
          <div
            id="stripe-fields"
            class:list={['provider-fields', { hidden: paymentProvider !== 'stripe' }]}
          >
            <h3 class="text-lg font-medium text-gray-900 mb-4">Stripe Configuration</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Secret Key <span class="text-red-500">*</span>
                </label>
                <input
                  type="password"
                  name="stripe_secret_key"
                  value={user.stripeSecretKey || ''}
                  placeholder="sk_live_..."
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                />
                <p class="text-xs text-gray-500 mt-1">
                  Get from <a
                    href="https://dashboard.stripe.com/apikeys"
                    target="_blank"
                    class="text-primary hover:underline">Stripe Dashboard</a
                  >
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Publishable Key <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  name="stripe_publishable_key"
                  value={user.stripePublishableKey || ''}
                  placeholder="pk_live_..."
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                />
              </div>
            </div>
          </div>

          <!-- Lemon Squeezy Fields -->
          <div
            id="lemon-squeezy-fields"
            class:list={['provider-fields', { hidden: paymentProvider !== 'lemon_squeezy' }]}
          >
            <h3 class="text-lg font-medium text-gray-900 mb-4">Lemon Squeezy Configuration</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  API Key <span class="text-red-500">*</span>
                </label>
                <input
                  type="password"
                  name="lemon_squeezy_api_key"
                  value={user.lemonSqueezyApiKey || ''}
                  placeholder="Your Lemon Squeezy API key"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                />
                <p class="text-xs text-gray-500 mt-1">
                  Get from <a
                    href="https://app.lemonsqueezy.com/settings/api"
                    target="_blank"
                    class="text-primary hover:underline">Lemon Squeezy Settings</a
                  >
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Store ID <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  name="lemon_squeezy_store_id"
                  value={user.lemonSqueezyStoreId || ''}
                  placeholder="12345"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                />
              </div>
            </div>
          </div>

          <!-- Gumroad Fields -->
          <div
            id="gumroad-fields"
            class:list={['provider-fields', { hidden: paymentProvider !== 'gumroad' }]}
          >
            <h3 class="text-lg font-medium text-gray-900 mb-4">Gumroad Configuration</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Access Token <span class="text-red-500">*</span>
                </label>
                <input
                  type="password"
                  name="gumroad_access_token"
                  value={user.gumroadAccessToken || ''}
                  placeholder="Your Gumroad access token"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                />
                <p class="text-xs text-gray-500 mt-1">
                  Get from <a
                    href="https://app.gumroad.com/settings/advanced"
                    target="_blank"
                    class="text-primary hover:underline">Gumroad Advanced Settings</a
                  >
                </p>
              </div>
            </div>
          </div>

          <!-- Paddle Fields -->
          <div
            id="paddle-fields"
            class:list={['provider-fields', { hidden: paymentProvider !== 'paddle' }]}
          >
            <h3 class="text-lg font-medium text-gray-900 mb-4">Paddle Configuration</h3>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Vendor ID <span class="text-red-500">*</span>
                </label>
                <input
                  type="text"
                  name="paddle_vendor_id"
                  value={user.paddleVendorId || ''}
                  placeholder="12345"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  API Key <span class="text-red-500">*</span>
                </label>
                <input
                  type="password"
                  name="paddle_api_key"
                  value={user.paddleApiKey || ''}
                  placeholder="Your Paddle API key"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                />
                <p class="text-xs text-gray-500 mt-1">
                  Get from <a
                    href="https://vendors.paddle.com/authentication"
                    target="_blank"
                    class="text-primary hover:underline">Paddle Authentication</a
                  >
                </p>
              </div>
            </div>
          </div>

          <!-- Submit Button -->
          <div class="mt-6 flex gap-4">
            <button
              type="submit"
              class="px-6 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors font-medium"
            >
              Save Payment Provider
            </button>
            {
              paymentProvider && (
                <button
                  type="button"
                  id="disconnect-btn"
                  class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium"
                >
                  Disconnect Provider
                </button>
              )
            }
          </div>
        </form>
      </div>

      <!-- GitHub PAT Section -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">GitHub Personal Access Token</h2>
        <p class="text-sm text-gray-600 mb-6">
          Required to automatically add customers as collaborators to your private repositories.
        </p>

        <form method="POST" action="/api/dashboard/settings/github-pat">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Personal Access Token <span class="text-red-500">*</span>
            </label>
            <input
              type="password"
              name="github_pat"
              value={user.githubPersonalAccessToken ? '••••••••••••••••' : ''}
              placeholder="ghp_..."
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
            />
            <p class="text-xs text-gray-500 mt-1">
              Generate at <a
                href="https://github.com/settings/tokens/new?scopes=repo"
                target="_blank"
                class="text-primary hover:underline">GitHub Settings</a
              > (requires 'repo' scope)
            </p>
          </div>

          <button
            type="submit"
            class="px-6 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors font-medium"
          >
            Save GitHub Token
          </button>
        </form>
      </div>

      <!-- Email Preferences Section (GDPR Compliance) -->
      <div class="bg-white rounded-lg shadow-md p-6 mt-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Email Preferences</h2>
        <p class="text-sm text-gray-600 mb-6">
          Control what emails you receive from RepoPass. Note: Critical notifications about your
          account will still be sent.
        </p>

        <form method="POST" action="/api/dashboard/settings/email-preferences">
          <div class="mb-4">
            <label class="flex items-center space-x-3">
              <input
                type="checkbox"
                name="email_notifications"
                checked={user.emailNotifications}
                class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary"
              />
              <span class="text-sm text-gray-700">
                I want to receive email notifications about purchases, updates, and announcements
              </span>
            </label>
            <p class="text-xs text-gray-500 mt-2 ml-7">
              Uncheck to opt-out of non-essential emails. You'll still receive critical account and
              payment notifications.
            </p>
          </div>

          <button
            type="submit"
            class="px-6 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors font-medium"
          >
            Save Preferences
          </button>
        </form>
      </div>
    </main>

    <script>
      // Show/hide provider fields based on selection
      const providerSelect = document.getElementById('provider-select');
      const providerFields = document.querySelectorAll('.provider-fields');

      providerSelect?.addEventListener('change', (e) => {
        const selected = (e.target as HTMLSelectElement).value;
        providerFields.forEach((field) => {
          field.classList.add('hidden');
        });

        if (selected) {
          const targetId = selected.replace('_', '-') + '-fields';
          document.getElementById(targetId)?.classList.remove('hidden');
        }
      });

      // Disconnect provider
      const disconnectBtn = document.getElementById('disconnect-btn');
      disconnectBtn?.addEventListener('click', async () => {
        if (!confirm('Are you sure you want to disconnect your payment provider?')) {
          return;
        }

        const response = await fetch('/api/dashboard/settings/disconnect-provider', {
          method: 'POST',
        });

        if (response.ok) {
          window.location.reload();
        } else {
          alert('Failed to disconnect provider');
        }
      });
    </script>
  </div>

  <Footer />
</Layout>
