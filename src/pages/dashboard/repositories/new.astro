---
import PostHogLayout from '@/layouts/PostHogLayout.astro';
import Layout from '../../../layouts/main.astro';
import DashboardNav from '../../../components/DashboardNav.astro';
import Footer from '../../../components/Footer.astro';
import { requireAuth } from '../../../lib/auth';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '../../../components/ui/card';
import { Button } from '../../../components/ui/button';

// Require authentication
await requireAuth(Astro.cookies).catch(() => {
  return Astro.redirect('/');
});
---

<PostHogLayout>
  <Layout title="Add Repository - RepoPass">
    <div class="min-h-screen bg-background flex flex-col">
      <DashboardNav />

      <main class="flex-1 max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        <!-- Page Header -->
        <div class="mb-8">
          <h1 class="text-3xl font-bold tracking-tight">Add Repository</h1>
          <p class="text-muted-foreground mt-2">
            Connect a GitHub repository to start monetizing access
          </p>
        </div>

        <Card client:load>
          <CardHeader>
            <CardTitle>Repository Details</CardTitle>
            <CardDescription>Select a repository or enter details manually</CardDescription>
          </CardHeader>
          <CardContent>
            <form id="add-repo-form" class="space-y-6">
              <!-- Repository Selector -->
              <div class="pb-6 border-b border-gray-200">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Select from your GitHub repositories
                </label>
                <select
                  id="repo-selector"
                  class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2 border"
                >
                  <option value="">Loading your repositories...</option>
                </select>
                <p class="mt-2 text-sm text-gray-500">Or manually enter repository details below</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">GitHub Owner</label>
                <input
                  type="text"
                  name="githubOwner"
                  required
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2 border"
                  placeholder="e.g., ctrimm"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Repository Name</label>
                <input
                  type="text"
                  name="githubRepoName"
                  required
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2 border"
                  placeholder="e.g., premium-astro-theme"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Display Name</label>
                <input
                  type="text"
                  name="displayName"
                  required
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2 border"
                  placeholder="e.g., Premium Astro Theme"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea
                  name="description"
                  rows="3"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2 border"
                  placeholder="A beautiful, production-ready theme..."></textarea>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Price (USD)</label>
                <input
                  type="number"
                  name="price"
                  required
                  min="1"
                  step="0.01"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2 border"
                  placeholder="49.00"
                />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Pricing Type</label>
                <select
                  name="pricingType"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2 border"
                >
                  <option value="one-time">One-time Purchase</option>
                  <option value="subscription">Subscription</option>
                </select>
              </div>

              <div id="subscription-options" class="hidden">
                <label class="block text-sm font-medium text-gray-700">Billing Interval</label>
                <select
                  name="subscriptionCadence"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-4 py-2 border"
                >
                  <option value="monthly">Monthly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>

              <div class="flex gap-4 pt-4">
                <button
                  type="submit"
                  class="bg-primary hover:bg-primary/90 text-primary-foreground px-6 py-2 rounded-lg font-medium transition-colors"
                >
                  Create Repository
                </button>
                <a
                  href="/dashboard"
                  class="bg-secondary hover:bg-secondary/80 text-secondary-foreground px-6 py-2 rounded-lg font-medium transition-colors inline-block"
                >
                  Cancel
                </a>
              </div>
            </form>
          </CardContent>
        </Card>
      </main>

      <Footer />
    </div>
  </Layout>
</PostHogLayout>

<script>
  const form = document.getElementById('add-repo-form') as HTMLFormElement;
  const pricingType = form.querySelector('[name="pricingType"]') as HTMLSelectElement;
  const subscriptionOptions = document.getElementById('subscription-options');
  const repoSelector = document.getElementById('repo-selector') as HTMLSelectElement;

  // Fetch user's repositories
  async function loadRepositories() {
    try {
      const response = await fetch('/api/auth/github/repositories');
      if (!response.ok) {
        throw new Error('Failed to fetch repositories');
      }

      const { repositories } = await response.json();

      // Clear loading option
      repoSelector.innerHTML = '<option value="">-- Select a repository --</option>';

      // Add repositories to dropdown
      repositories.forEach((repo: any) => {
        const option = document.createElement('option');
        option.value = JSON.stringify(repo);
        option.textContent = `${repo.fullName} ${repo.isPrivate ? '(Private)' : '(Public)'}`;
        repoSelector.appendChild(option);
      });
    } catch (error) {
      console.error('Error loading repositories:', error);
      repoSelector.innerHTML = '<option value="">Failed to load repositories</option>';
    }
  }

  // Auto-fill form when repository is selected
  repoSelector.addEventListener('change', (e) => {
    const value = (e.target as HTMLSelectElement).value;
    if (!value) return;

    try {
      const repo = JSON.parse(value);

      // Auto-fill form fields
      (form.querySelector('[name="githubOwner"]') as HTMLInputElement).value = repo.owner;
      (form.querySelector('[name="githubRepoName"]') as HTMLInputElement).value = repo.name;
      (form.querySelector('[name="displayName"]') as HTMLInputElement).value = repo.name
        .split('-')
        .map((word: string) => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
      (form.querySelector('[name="description"]') as HTMLTextAreaElement).value =
        repo.description || '';
    } catch (error) {
      console.error('Error parsing repository data:', error);
    }
  });

  // Load repositories on page load
  loadRepositories();

  pricingType.addEventListener('change', () => {
    if (pricingType.value === 'subscription') {
      subscriptionOptions?.classList.remove('hidden');
    } else {
      subscriptionOptions?.classList.add('hidden');
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const price = parseFloat(formData.get('price') as string);

    const data = {
      githubOwner: formData.get('githubOwner'),
      githubRepoName: formData.get('githubRepoName'),
      displayName: formData.get('displayName'),
      description: formData.get('description'),
      priceCents: Math.round(price * 100),
      pricingType: formData.get('pricingType'),
      subscriptionCadence:
        formData.get('pricingType') === 'subscription'
          ? formData.get('subscriptionCadence')
          : undefined,
    };

    try {
      const response = await fetch('/api/dashboard/admin/repositories', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        window.location.href = '/dashboard';
      } else {
        const error = await response.json();
        alert(`Error: ${error.error || 'Failed to create repository'}`);
      }
    } catch (error) {
      alert('Error creating repository');
      console.error(error);
    }
  });
</script>
