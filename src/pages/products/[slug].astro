---
import PostHogLayout from '@/layouts/PostHogLayout.astro';
import Layout from '../../layouts/main.astro';
import { db, repositories } from '../../db';
import { eq } from 'drizzle-orm';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

// Get repository
const repository = await db.query.repositories.findFirst({
  where: eq(repositories.slug, slug),
});

if (!repository || !repository.active) {
  return Astro.redirect('/404');
}
---

<PostHogLayout>
  <Layout title={`${repository.displayName} - RepoPass`}>
    <div class="min-h-screen bg-gray-50 py-12 px-4">
      <div class="max-w-4xl mx-auto">
        <!-- Product Details -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
          {
            repository.coverImageUrl && (
              <img
                src={repository.coverImageUrl}
                alt={repository.displayName}
                class="w-full h-64 object-cover"
              />
            )
          }

          <div class="p-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">{repository.displayName}</h1>

            <div class="flex items-center gap-4 mb-6 text-gray-600">
              <span class="flex items-center gap-1">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"
                  ></path>
                </svg>
                {repository.githubOwner}/{repository.githubRepoName}
              </span>
              {
                repository.githubStars && repository.githubStars > 0 && (
                  <span class="flex items-center gap-1">
                    <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                    {repository.githubStars}
                  </span>
                )
              }
            </div>

            {
              repository.description && (
                <p class="text-lg text-gray-700 mb-8">{repository.description}</p>
              )
            }

            <!-- Pricing -->
            <div class="bg-primary/5 rounded-lg p-6 mb-8">
              <div class="flex items-baseline gap-2 mb-2">
                <span class="text-4xl font-bold text-gray-900">
                  ${(repository.priceCents / 100).toFixed(2)}
                </span>
                {
                  repository.pricingType === 'subscription' && (
                    <span class="text-gray-600">/ {repository.subscriptionCadence}</span>
                  )
                }
              </div>
              <p class="text-sm text-gray-600">
                {
                  repository.pricingType === 'one-time'
                    ? 'One-time payment • Lifetime access'
                    : 'Subscription • Cancel anytime'
                }
              </p>
            </div>

            <!-- Checkout Form -->
            <form id="checkout-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Your GitHub Username
                </label>
                <input
                  type="text"
                  name="githubUsername"
                  required
                  pattern="[a-zA-Z0-9]([a-zA-Z0-9]|-(?=[a-zA-Z0-9])){0,38}"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  placeholder="your-github-username"
                />
                <p class="mt-1 text-sm text-gray-500">
                  This username will be added as a collaborator to the repository
                </p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"> Email Address </label>
                <input
                  type="email"
                  name="email"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
                  placeholder="you@example.com"
                />
                <p class="mt-1 text-sm text-gray-500">
                  For order confirmation and access instructions
                </p>
              </div>

              <button
                type="submit"
                class="w-full bg-primary hover:bg-primary/90 text-primary-foreground font-semibold py-4 px-6 rounded-lg transition-colors text-lg"
                id="submit-button"
              >
                Purchase Access
              </button>

              <p class="text-xs text-center text-gray-500">
                By purchasing, you agree to our terms. Access may be revoked for violations.
              </p>
            </form>

            <!-- What You Get -->
            <div class="mt-12 border-t pt-8">
              <h2 class="text-2xl font-bold text-gray-900 mb-4">What You Get</h2>
              <ul class="space-y-3">
                <li class="flex items-start gap-3">
                  <svg
                    class="w-6 h-6 text-green-500 flex-shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span class="text-gray-700">Full read access to the private repository</span>
                </li>
                <li class="flex items-start gap-3">
                  <svg
                    class="w-6 h-6 text-green-500 flex-shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span class="text-gray-700">Ability to clone and fork the repository</span>
                </li>
                <li class="flex items-start gap-3">
                  <svg
                    class="w-6 h-6 text-green-500 flex-shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span class="text-gray-700">Access granted within 5 minutes of purchase</span>
                </li>
                <li class="flex items-start gap-3">
                  <svg
                    class="w-6 h-6 text-green-500 flex-shrink-0 mt-0.5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 13l4 4L19 7"></path>
                  </svg>
                  <span class="text-gray-700">
                    {
                      repository.pricingType === 'one-time'
                        ? 'Lifetime access'
                        : 'Access as long as subscription is active'
                    }
                  </span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </Layout>
</PostHogLayout>

<script define:vars={{ repositoryId: repository.id }}>
  const form = document.getElementById('checkout-form');
  const submitButton = document.getElementById('submit-button');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    submitButton.disabled = true;
    submitButton.textContent = 'Processing...';

    const formData = new FormData(form);

    const data = {
      repositoryId,
      email: formData.get('email'),
      githubUsername: formData.get('githubUsername'),
    };

    try {
      const response = await fetch('/api/checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });

      if (response.ok) {
        const { sessionUrl } = await response.json();
        window.location.href = sessionUrl;
      } else {
        const error = await response.json();
        alert(`Error: ${error.error || 'Failed to create checkout session'}`);
        submitButton.disabled = false;
        submitButton.textContent = 'Purchase Access';
      }
    } catch (error) {
      alert('Error processing checkout');
      console.error(error);
      submitButton.disabled = false;
      submitButton.textContent = 'Purchase Access';
    }
  });
</script>
